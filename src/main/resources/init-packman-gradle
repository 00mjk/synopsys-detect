import java.nio.charset.StandardCharsets

import org.gradle.api.Task
import org.gradle.api.execution.TaskExecutionListener
import org.gradle.api.tasks.TaskState

import com.blackducksoftware.integration.hub.bdio.simple.model.DependencyNode
import com.blackducksoftware.integration.hub.packman.packagemanager.gradle.DependencyGatherer
import com.google.gson.Gson
import com.google.gson.stream.JsonWriter

initscript {
    repositories {
        mavenLocal()
        mavenCentral()
    }
    dependencies { classpath 'com.blackducksoftware.integration:hub-packman:0.0.1-SNAPSHOT' }
}

addListener(
        new TaskExecutionListener() {
            boolean executed = false;

            void beforeExecute(Task task) { }
            void afterExecute(Task task, TaskState state) {
                if (executed) {
                    return
                } else {
                    executed = true
                }

                def dependencyGatherer = new DependencyGatherer()
                DependencyNode rootProjectDependencyNode = dependencyGatherer.getFullyPopulatedRootNode(task.project)
                File outputDirectory = new File(task.project.buildDir, 'blackduck')
                outputDirectory.mkdirs()
                File outputFile = new File(outputDirectory, 'dependencyNodes.json')
                outputFile << new Gson().toJson(rootProjectDependencyNode)
            }
        })
